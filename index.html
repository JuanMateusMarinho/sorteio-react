<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>.::Sorteios::.</title>
    <link rel="stylesheet" href="/global.css">
  </head>
  <body>
    <header>
      <h1>..::SORTEIOS::..</h1>
    </header>
    <section class="raffle-section">
      <p1>Sorteie usuários da tabela abaixo.</p1>
      <button class="raffle-button">Sorteie um Usuário</button>
    </section>
    <section class="create-user-section">
       <p1 class="text-green">Ou adicione um novo:</p1>
      <nav>
        <button class="create-user-button"><a href="src/novouser.html">Adicionar Novos Usuários</a></button>
      </nav>
    </section> 
    <section>
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Opções</th>
          </tr>
        </thead>
        <tbody>
          <!-- Linhas de usuários serão inseridas aqui -->
        </tbody>
      </table>
    </section>

    <!-- Modal de Confirmação de Deleção -->
    <div id="deleteConfirmModal" class="modal">
      <div class="modal-content">
        <span class="close-confirm">&times;</span>
        <p>Deseja deletar o usuário?</p>
        <button id="confirmDeleteBtn" class="action-button delete">Ok</button>
        <button id="cancelDeleteBtn" class="action-button">Cancelar</button>
      </div>
    </div>

      <!-- Modal de Confirmação de Alteração -->
      <div id="editConfirmModal" class="modal">
        <div class="modal-content">
          <span class="close-edit-confirm">&times;</span>
          <p>Deseja alterar o usuário?</p>
          <button id="confirmEditBtn" class="action-button edit">Ok</button>
          <button id="cancelEditBtn" class="action-button">Cancelar</button>
        </div>
      </div>

    <!-- Modal de Sucesso de Deleção -->
    <div id="deleteSuccessModal" class="modal">
      <div class="modal-content">
        <p>Usuário Deletado com Sucesso!</p>
        <button id="deleteSuccessOkBtn" class="action-button">Ok</button>
      </div>
    </div>

    <!-- Modal do Vencedor do Sorteio -->
    <div id="raffleWinnerModal" class="modal">
      <div class="modal-content">
        <span class="close-raffle-winner">&times;</span>
        <h2 class="winner-title">🎉 Parabéns! 🎉</h2>
        <p>O usuário sorteado foi:</p>
        <p id="winnerName"></p>
        <p id="winnerEmail"></p>
        <button id="closeRaffleModalBtn" class="action-button">Fechar</button>
      </div>
    </div>

    <footer>
      <p>Admin Client &copy; 2025</p>
    </footer>
    <div id="root"></div>
    <!-- <script type="module" src="/src/main.jsx"></script> -->
    <script>
      // Função para buscar usuários do backend e preencher a tabela
      async function fetchAndDisplayUsers() {
        const tbody = document.querySelector("table tbody");
        tbody.innerHTML = ""; // Limpa a tabela antes de preencher

        const loadingRow = document.createElement('tr');
        const loadingCell = document.createElement('td');
        loadingCell.colSpan = 3;
        loadingCell.textContent = 'Carregando usuários...';
        loadingRow.appendChild(loadingCell);
        tbody.appendChild(loadingRow);

        let users = [];
        try {
          const res = await fetch('http://localhost:3000/sorteio/list-user');
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          users = await res.json();
        } catch (err) {
          console.warn('Erro ao buscar usuários:', err);
          console.error('Erro ao buscar usuários:', err);
          // fallback: mock local
          users = [ { name: 'Usuário de Teste', email: 'teste@exemplo.com' } ];
        }

        // Limpa e popula com os usuários (reais ou mock)
        tbody.innerHTML = '';

        console.log('Dados recebidos do backend:', users);

        users.forEach(user => {
          const tr = document.createElement('tr');
          tr.dataset.id = user.id; // Adiciona o ID do usuário à linha da tabela

          const tdName = document.createElement('td');
          tdName.className = 'user-name';
          tdName.textContent = user.name || '';
          tr.appendChild(tdName);

          const tdEmail = document.createElement('td');
          tdEmail.className = 'user-email';
          tdEmail.textContent = user.email || '';
          tr.appendChild(tdEmail);

          const tdActions = document.createElement('td');
          tdActions.className = 'action-cell';
          tdActions.style.display = 'flex';
          tdActions.style.flexDirection = 'column';
          tdActions.style.gap = '8px';

          const editBtn = document.createElement('button');
          editBtn.textContent = 'Alterar';
          editBtn.className = 'action-button edit';
          tdActions.appendChild(editBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Deletar';
          deleteBtn.className = 'action-button delete';
          tdActions.appendChild(deleteBtn);

          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });
      }

      // Executa a função quando o conteúdo da página for carregado
      document.addEventListener('DOMContentLoaded', fetchAndDisplayUsers);

      // Lógica do Modal de Confirmação de Deleção
      const deleteModal = document.getElementById('deleteConfirmModal');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
      const closeConfirmSpan = document.querySelector('.close-confirm');
      const deleteSuccessModal = document.getElementById('deleteSuccessModal');
      const deleteSuccessOkBtn = document.getElementById('deleteSuccessOkBtn');
      let rowToDelete = null;

      document.querySelector('table tbody').addEventListener('click', function(event) {
        if (event.target.classList.contains('delete')) {
          rowToDelete = event.target.closest('tr');
          deleteModal.style.display = 'block';
        }
          if (event.target.classList.contains('edit')) {
            rowToEdit = event.target.closest('tr');
            editModal.style.display = 'block';
            // Captura os dados do usuário selecionado
            const id = rowToEdit.dataset.id || ''; // Pega o ID
            const name = rowToEdit.querySelector('.user-name')?.textContent || '';
            const email = rowToEdit.querySelector('.user-email')?.textContent || '';
            // Armazena para uso no redirecionamento
            rowToEdit.dataset.id = id;
            rowToEdit.dataset.name = name;
            rowToEdit.dataset.email = email;
          }
      });

      function closeModal() {
        deleteModal.style.display = 'none';
        rowToDelete = null;
          editModal.style.display = 'none';
          rowToEdit = null;
      }

      confirmDeleteBtn.addEventListener('click', async function() {
        if (rowToDelete) {
          const userId = rowToDelete.dataset.id;
          if (!userId) {
            alert('Erro: ID do usuário não encontrado.');
            closeModal();
            return;
          }

          try {
            const response = await fetch(`http://localhost:3000/sorteio/delete-user/${userId}`, {
              method: 'DELETE',
            });

            if (response.ok) {
              rowToDelete.remove();
              closeModal(); // Fecha o modal de confirmação
              deleteSuccessModal.style.display = 'block'; // Mostra o modal de sucesso
            } else {
              const errorData = await response.text();
              alert(`Erro ao deletar usuário: ${errorData}`);
              closeModal();
            }
          } catch (error) {
            console.error('Erro de rede:', error);
            alert('Erro de conexão ao tentar deletar o usuário. Verifique o console.');
            closeModal();
          }
        }
      });

      // Evento para o botão "Ok" do modal de sucesso de deleção
      deleteSuccessOkBtn.addEventListener('click', function() {
        deleteSuccessModal.style.display = 'none';
      });

        // Lógica do Modal de Confirmação de Alteração
        const editModal = document.getElementById('editConfirmModal');
        const confirmEditBtn = document.getElementById('confirmEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const closeEditConfirmSpan = document.querySelector('.close-edit-confirm');
        let rowToEdit = null;

        confirmEditBtn.addEventListener('click', function() {
            if (rowToEdit) {
              // Redireciona para a página de alteração levando nome e email
              const id = rowToEdit.dataset.id || '';
              const name = rowToEdit.dataset.name || '';
              const email = rowToEdit.dataset.email || '';
              const params = new URLSearchParams({ id, name, email });
              window.location.href = `src/alteraruser.html?${params.toString()}`;
            }
            closeModal();
        });

        cancelEditBtn.addEventListener('click', closeModal);
        closeEditConfirmSpan.addEventListener('click', closeModal);

      cancelDeleteBtn.addEventListener('click', closeModal);
      closeConfirmSpan.addEventListener('click', closeModal);
      window.addEventListener('click', function(event) {
        if (event.target == deleteModal) {
          closeModal();
        }
          if (event.target == editModal) {
            closeModal();
          }
      });

      // Lógica do Sorteio
      const raffleButton = document.querySelector('.raffle-button');
      raffleButton.addEventListener('click', function() {
        const tbody = document.querySelector("table tbody");
        const users = tbody.querySelectorAll('tr');

        if (users.length === 0) {
          alert('Não há usuários na tabela para sortear!');
          return;
        }

        // Remove o destaque de um vencedor anterior
        const previousWinner = document.querySelector('.winner');
        if (previousWinner) {
          previousWinner.classList.remove('winner');
        }

        // Sorteia um novo vencedor
        const randomIndex = Math.floor(Math.random() * users.length);
        const winnerRow = users[randomIndex];
        winnerRow.classList.add('winner');
        winnerRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

        const winnerName = winnerRow.querySelector('.user-name').textContent;
        const winnerEmail = winnerRow.querySelector('.user-email').textContent;

        // Preenche e exibe o modal do vencedor
        const winnerModal = document.getElementById('raffleWinnerModal');
        document.getElementById('winnerName').textContent = winnerName;
        document.getElementById('winnerEmail').textContent = winnerEmail;
        winnerModal.style.display = 'block';

        // Lógica para fechar o modal do vencedor
        const closeRaffleBtn = document.getElementById('closeRaffleModalBtn');
        const closeRaffleSpan = document.querySelector('.close-raffle-winner');

        function closeRaffleModal() {
          winnerModal.style.display = 'none';
        }

        closeRaffleBtn.addEventListener('click', closeRaffleModal);
        closeRaffleSpan.addEventListener('click', closeRaffleModal);
        window.addEventListener('click', function(event) {
          if (event.target == winnerModal) {
            closeRaffleModal();
          }
        });
      });
    </script>
  </body> 
</html>
     
